name: Build Repo Listing

env:
    listPublishDirectory: Website
    packageName: "com.sodanen.sodanenlighteditor"

on:
    workflow_dispatch:
    workflow_run:
        workflows: [Build Release]
        types:
            - completed
    release:
        types: [published, created, edited, unpublished, deleted, released]

permissions:
    contents: read
    pages: write
    id-token: write

concurrency:
    group: "pages"
    cancel-in-progress: true

jobs:
    build-listing:
        name: build-listing
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Get All Releases
              id: get_releases
              run: |
                  echo "Fetching all releases..."
                  gh release list --json tagName,isDraft,isPrerelease --limit 100 > releases.json
                  cat releases.json
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Build Package Listing
              run: |
                  # Read base package.json
                  PACKAGE_JSON=$(cat package.json)
                  PACKAGE_NAME=$(echo "$PACKAGE_JSON" | jq -r '.name')

                  # Initialize versions object
                  echo '{}' > versions.json

                  # Get all release tags
                  TAGS=$(gh release list --json tagName --jq '.[].tagName')

                  for TAG in $TAGS; do
                      echo "Processing release: $TAG"

                      # Download package.json from release
                      if gh release download "$TAG" --pattern "package.json" --dir "./temp" --clobber 2>/dev/null; then
                          RELEASE_PACKAGE=$(cat ./temp/package.json)

                          # Add download URL
                          ZIP_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/${{ env.packageName }}-${TAG}.zip"
                          RELEASE_PACKAGE=$(echo "$RELEASE_PACKAGE" | jq --arg url "$ZIP_URL" '. + {url: $url}')

                          # Add to versions
                          VERSION=$(echo "$RELEASE_PACKAGE" | jq -r '.version')
                          jq --arg ver "$VERSION" --argjson pkg "$RELEASE_PACKAGE" '.[$ver] = $pkg' versions.json > versions.tmp && mv versions.tmp versions.json

                          rm -rf ./temp
                      fi
                  done

                  # Build final index.json
                  jq -n \
                      --arg name "Sodanen VPM Packages" \
                      --arg id "com.sodanen.vpm" \
                      --arg url "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/index.json" \
                      --arg author_name "Sodanen" \
                      --arg author_url "https://github.com/VRSoda" \
                      --arg pkg_name "$PACKAGE_NAME" \
                      --slurpfile versions versions.json \
                      '{
                          name: $name,
                          id: $id,
                          url: $url,
                          author: {
                              name: $author_name,
                              url: $author_url
                          },
                          packages: {
                              ($pkg_name): {
                                  versions: $versions[0]
                              }
                          }
                      }' > ${{ env.listPublishDirectory }}/index.json

                  # Create source.json
                  jq -n \
                      --arg name "Sodanen VPM Packages" \
                      --arg id "com.sodanen.vpm" \
                      --arg url "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/index.json" \
                      --arg author_name "Sodanen" \
                      --arg author_url "https://github.com/VRSoda" \
                      '{
                          name: $name,
                          id: $id,
                          url: $url,
                          author: {
                              name: $author_name,
                              url: $author_url
                          },
                          infoLink: {
                              text: "GitHub",
                              url: "https://github.com/${{ github.repository }}"
                          }
                      }' > ${{ env.listPublishDirectory }}/source.json

                  echo "Generated index.json:"
                  cat ${{ env.listPublishDirectory }}/index.json
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Pages
              uses: actions/configure-pages@v5

            - name: Upload Pages Artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: ${{ env.listPublishDirectory }}

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
